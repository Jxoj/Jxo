<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jxo Account</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html,body{
  margin:0;
  height:100%;
  background:#121212;
  font-family:system-ui;
  color:#eaeaea;
}

.center{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100%;
  padding:20px;
}

.card{
  width:760px;
  background:#1c1c1c;
  border-radius:24px;
  padding:36px 48px;
  box-shadow:0 24px 60px rgba(0,0,0,.7);
}

.logo{
  display:flex;
  align-items:center;
  gap:16px;
  margin-bottom:20px;
}

.logo-circle{
  width:64px;
  height:64px;
  border-radius:50%;
  background:linear-gradient(135deg,#4285f4,#34a853);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  font-weight:700;
}

h1{margin:0 0 6px;font-weight:500}
.sub{color:#aaa;margin-bottom:18px}

/* ---- STEP CONTAINERS ---- */
.step{
  display:none;
  opacity:0;
  transform:translateX(20px);
  transition:opacity .3s ease, transform .3s ease;
}

.step.active{
  display:block;
  animation:fadeSlide .3s ease forwards;
}

@keyframes fadeSlide{
  from{opacity:0;transform:translateX(20px)}
  to{opacity:1;transform:translateX(0)}
}

/* ---- INPUTS ---- */
.input{
  width:100%;
  padding:13px;
  font-size:16px;
  background:#121212;
  border:1px solid #333;
  border-radius:10px;
  color:#fff;
  margin-bottom:16px;
  box-sizing:border-box;
}

.input:focus{
  outline:none;
  border-color:#8ab4f8;
}

/* ---- BUTTONS ---- */
.btn{
  width:100%;
  margin-top:14px;
  background:#8ab4f8;
  border:none;
  border-radius:24px;
  padding:14px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  color:#121212;
}

.btn:hover{
  background:#a8c7fa;
}

.btn:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

.link{
  margin-top:12px;
  text-align:center;
  color:#8ab4f8;
  cursor:pointer;
  font-size:14px;
}

.link:hover{
  text-decoration:underline;
}

.status{
  margin-top:14px;
  min-height:18px;
  color:#ff8a80;
  font-size:14px;
}

/* ---- ACCOUNTS ---- */
.account-list{
  margin-bottom:20px;
}

.account{
  display:flex;
  align-items:center;
  gap:14px;
  padding:14px;
  border:1px solid #333;
  border-radius:14px;
  cursor:pointer;
  margin-bottom:12px;
  transition:background .2s ease, border-color .2s ease;
  position:relative;
}

.account:hover{
  background:#252525;
  border-color:#444;
}

.account-avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  background:linear-gradient(135deg,#8ab4f8,#4285f4);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:700;
  flex-shrink:0;
  overflow:hidden;
}

.account-avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.account-info{
  flex:1;
}

.account-name{
  font-weight:600;
  font-size:16px;
  margin-bottom:2px;
}

.account-email{
  font-size:14px;
  color:#aaa;
}

.account-remove{
  position:absolute;
  top:8px;
  right:8px;
  width:24px;
  height:24px;
  border-radius:50%;
  background:#333;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  opacity:0;
  transition:opacity .2s ease;
}

.account:hover .account-remove{
  opacity:1;
}

.account-remove:hover{
  background:#444;
}

.divider{
  display:flex;
  align-items:center;
  gap:12px;
  margin:20px 0;
  color:#666;
  font-size:14px;
}

.divider::before,
.divider::after{
  content:'';
  flex:1;
  height:1px;
  background:#333;
}

/* ---- PROFILE PIC UPLOAD ---- */
.profile-pic-section{
  text-align:center;
  margin-bottom:20px;
}

.profile-pic-preview{
  width:80px;
  height:80px;
  border-radius:50%;
  background:linear-gradient(135deg,#8ab4f8,#4285f4);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
  font-weight:700;
  margin-bottom:12px;
  overflow:hidden;
  cursor:pointer;
  transition:transform .2s ease;
}

.profile-pic-preview:hover{
  transform:scale(1.05);
}

.profile-pic-preview img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.profile-pic-label{
  color:#8ab4f8;
  cursor:pointer;
  font-size:14px;
}

.profile-pic-label:hover{
  text-decoration:underline;
}

#photoFile{
  display:none;
}

/* ---- BAN SCREEN ---- */
#banScreen{
  display:none;
  animation:fadeSlide .3s ease forwards;
}

.ban-icon{
  font-size:56px;
  text-align:center;
  margin-bottom:16px;
}

.ban-title{
  font-size:22px;
  font-weight:700;
  color:#ff8a80;
  text-align:center;
  margin-bottom:8px;
}

.ban-subtitle{
  color:#aaa;
  text-align:center;
  font-size:14px;
  margin-bottom:24px;
}

.ban-details{
  background:#121212;
  border:1px solid #3a1a1a;
  border-radius:12px;
  padding:18px 20px;
}

.ban-row{
  display:flex;
  gap:12px;
  margin-bottom:12px;
  font-size:14px;
}

.ban-row:last-child{
  margin-bottom:0;
}

.ban-label{
  color:#888;
  min-width:90px;
  flex-shrink:0;
}

.ban-value{
  color:#eaeaea;
  word-break:break-all;
}

.ban-word-chip{
  display:inline-block;
  background:#3a1a1a;
  border:1px solid #ff8a80;
  color:#ff8a80;
  border-radius:20px;
  padding:2px 10px;
  font-size:12px;
  margin:2px 2px 2px 0;
}
</style>
</head>

<body>
<div class="center">
<div class="card">

<div class="logo">
  <div class="logo-circle">J</div>
  <strong style="font-size:28px">Jxo</strong>
</div>

<h1 id="title">Sign in</h1>
<div class="sub" id="subtitle">Choose an account</div>

<!-- BAN SCREEN -->
<div id="banScreen">
  <div class="ban-icon">üö´</div>
  <div class="ban-title">Access Denied</div>
  <div class="ban-subtitle">This email address is not permitted to access Jxo.</div>
  <div class="ban-details">
    <div class="ban-row">
      <span class="ban-label">Email</span>
      <span class="ban-value" id="banEmail">‚Äî</span>
    </div>
    <div class="ban-row">
      <span class="ban-label">Reason</span>
      <span class="ban-value" id="banReason">‚Äî</span>
    </div>
    <div class="ban-row">
      <span class="ban-label">Matched</span>
      <span class="ban-value" id="banWords">‚Äî</span>
    </div>
  </div>
  <button class="btn" onclick="dismissBan()" style="margin-top:20px;background:#333;color:#eaeaea">‚Üê Go back</button>
</div>

<!-- MAIN CONTENT -->
<div id="mainContent">
  <!-- ACCOUNT LIST -->
  <div id="accountList" class="account-list"></div>

  <!-- STEP 0 -->
  <div id="step-email" class="step">
    <input id="email" class="input" placeholder="Email" type="email" autocomplete="email">
  </div>

  <!-- STEP 1 -->
  <div id="step-password" class="step">
    <input id="password" class="input" type="password" placeholder="Password" autocomplete="current-password">
  </div>

  <!-- STEP 2 -->
  <div id="step-profile" class="step">
    <div class="profile-pic-section">
      <div class="profile-pic-preview" id="profilePicPreview" onclick="document.getElementById('photoFile').click()">
        <span id="profileInitial">?</span>
      </div>
      <label class="profile-pic-label" for="photoFile">Upload profile picture</label>
      <input type="file" id="photoFile" accept="image/*">
    </div>
    <input id="displayName" class="input" placeholder="Display name" autocomplete="name">
  </div>

  <button id="nextBtn" class="btn">Next</button>
  <div id="toggle" class="link">Use another account</div>
  <div id="status" class="status"></div>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  updateProfile
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ---- FIREBASE ---- */
const app = initializeApp({
  apiKey:"AIzaSyDUFBrPl8YJwkmqwibq730VX2mtCkxaMeM",
  authDomain:"jxoaccount.firebaseapp.com",
  projectId:"jxoaccount"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* ---- ELEMENTS ---- */
const accountList = document.getElementById("accountList");
const email = document.getElementById("email");
const password = document.getElementById("password");
const displayName = document.getElementById("displayName");
const photoFile = document.getElementById("photoFile");
const profilePicPreview = document.getElementById("profilePicPreview");
const profileInitial = document.getElementById("profileInitial");
const nextBtn = document.getElementById("nextBtn");
const toggle = document.getElementById("toggle");
const title = document.getElementById("title");
const subtitle = document.getElementById("subtitle");
const status = document.getElementById("status");
const banScreen = document.getElementById("banScreen");
const mainContent = document.getElementById("mainContent");

const steps = {
  email: document.getElementById("step-email"),
  password: document.getElementById("step-password"),
  profile: document.getElementById("step-profile")
};

/* ---- STATE ---- */
let mode = "signin";
let step = "email";
let uploadedPhotoBase64 = null;
let isTrustedSite = false;
let trustedSitesData = null;
let bansData = null; // loaded ban list

/* ---- BAN SYSTEM ---- */
async function loadBans(){
  try {
    const res = await fetch('https://jxoj.github.io/Jxo/account/bans.json');
    if(!res.ok) throw new Error("HTTP " + res.status);
    bansData = await res.json();
  } catch(e) {
    console.warn("Could not load bans list:", e);
    bansData = null;
  }
}

/**
 * Check if an email matches any banned word/name.
 * Expected bans.json format:
 * {
 *   "bans": [
 *     { "word": "badword", "reason": "Hate speech" },
 *     ...
 *   ]
 * }
 * Returns { banned: true, reason, matchedWords } or { banned: false }
 */
function checkEmailBanned(emailValue){
  if(!bansData || !Array.isArray(bansData.bans)) return { banned: false };

  const lowerEmail = emailValue.toLowerCase();
  const matched = [];

  for(const entry of bansData.bans){
    const word = (entry.word || entry.name || "").toLowerCase().trim();
    if(!word) continue;
    if(lowerEmail.includes(word)){
      matched.push({ word: entry.word || entry.name, reason: entry.reason || "Banned content" });
    }
  }

  if(matched.length === 0) return { banned: false };

  // Collect unique reasons and words
  const reasons = [...new Set(matched.map(m => m.reason))].join("; ");
  const words = matched.map(m => m.word);
  return { banned: true, reason: reasons, matchedWords: words };
}

function showBanScreen(emailValue, reason, matchedWords){
  document.getElementById("banEmail").textContent = emailValue;
  document.getElementById("banReason").textContent = reason;
  document.getElementById("banWords").innerHTML = matchedWords
    .map(w => `<span class="ban-word-chip">${w}</span>`)
    .join(" ");

  mainContent.style.display = "none";
  banScreen.style.display = "block";
  title.textContent = "Account Banned";
  subtitle.textContent = "This email cannot be used";
}

window.dismissBan = function(){
  banScreen.style.display = "none";
  mainContent.style.display = "block";
  title.textContent = mode === "signin" ? "Sign in" : "Create account";
  subtitle.textContent = mode === "signin" ? "Use your Jxo Account" : "Create your Jxo Account";
  // Reset back to email step
  step = "email";
  showStep("email");
  email.value = "";
  password.value = "";
  status.textContent = "";
  nextBtn.textContent = "Next";
  nextBtn.disabled = false;
  requestAnimationFrame(() => email.focus());
};

/* ---- LOCAL STORAGE ---- */
function getSavedAccounts(){
  const saved = localStorage.getItem("jxoAccounts");
  return saved ? JSON.parse(saved) : [];
}

function saveAccount(user, photoURL, saveSession = false){
  const accounts = getSavedAccounts();
  const existing = accounts.findIndex(a => a.email === user.email);
  
  const account = {
    email: user.email,
    displayName: user.displayName || user.email,
    photoURL: photoURL || null,
    uid: user.uid,
    lastSignIn: saveSession ? Date.now() : (existing >= 0 ? accounts[existing].lastSignIn : null)
  };

  if(existing >= 0){
    accounts[existing] = account;
  } else {
    accounts.push(account);
  }

  localStorage.setItem("jxoAccounts", JSON.stringify(accounts));
}

function removeAccount(email){
  const accounts = getSavedAccounts();
  const filtered = accounts.filter(a => a.email !== email);
  localStorage.setItem("jxoAccounts", JSON.stringify(filtered));
  renderAccounts();
}

function isSessionValid(account){
  if(!account.lastSignIn) return false;
  const thirtyDays = 30 * 24 * 60 * 60 * 1000;
  return (Date.now() - account.lastSignIn) < thirtyDays;
}

/* ---- TRUSTED SITES CHECK ---- */
async function checkTrustedSite(){
  try {
    const response = await fetch('https://jxoj.github.io/Jxo/ts.json');
    trustedSitesData = await response.json();
    
    const currentDomain = window.location.hostname;
    isTrustedSite = trustedSitesData.trustedSites.some(site => 
      currentDomain === site || currentDomain.endsWith('.' + site)
    );
    
    const hasSeenWarning = localStorage.getItem('jxoFirstTimeWarning');
    
    if (!hasSeenWarning) {
      localStorage.setItem('jxoFirstTimeWarning', 'true');
    }
    
    return isTrustedSite;
  } catch (error) {
    console.error('Failed to load trusted sites:', error);
    return false;
  }
}

function renderAccounts(){
  const accounts = getSavedAccounts();
  
  if(accounts.length === 0){
    accountList.innerHTML = "";
    accountList.style.display = "none";
    title.textContent = mode === "signin" ? "Sign in" : "Create account";
    subtitle.textContent = mode === "signin" ? "Use your Jxo Account" : "Create your Jxo Account";
    showStep("email");
    step = "email";
    toggle.textContent = "Don't have an account? Create one!";
    nextBtn.style.display = "block";
    return;
  }

  accountList.style.display = "block";
  title.textContent = "Choose an account";
  subtitle.textContent = "to continue to Jxo";
  
  accountList.innerHTML = accounts.map(acc => {
    const initial = acc.displayName ? acc.displayName[0].toUpperCase() : acc.email[0].toUpperCase();
    const avatarContent = acc.photoURL 
      ? `<img src="${acc.photoURL}" alt="${acc.displayName}">`
      : initial;

    return `
      <div class="account" data-email="${acc.email}">
        <div class="account-avatar">${avatarContent}</div>
        <div class="account-info">
          <div class="account-name">${acc.displayName}</div>
          <div class="account-email">${acc.email}</div>
        </div>
        <div class="account-remove" data-remove="${acc.email}">√ó</div>
      </div>
    `;
  }).join('');

  Object.values(steps).forEach(s=>s.classList.remove("active"));
  nextBtn.style.display = "none";
  toggle.textContent = "Use another account";
}

/* ---- HELPERS ---- */
function showStep(name){
  Object.values(steps).forEach(s=>s.classList.remove("active"));
  steps[name].classList.add("active");
  nextBtn.style.display = "block";
}

/* ---- PHOTO UPLOAD ---- */
photoFile.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = (evt) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const size = 200;
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      
      const scale = Math.max(size / img.width, size / img.height);
      const x = (size / 2) - (img.width / 2) * scale;
      const y = (size / 2) - (img.height / 2) * scale;
      ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
      
      uploadedPhotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
      profilePicPreview.innerHTML = `<img src="${uploadedPhotoBase64}" alt="Profile">`;
    };
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
});

/* ---- FIRESTORE PHOTO SAVE ---- */
async function savePhotoToFirestore(userId, base64Photo){
  if(!base64Photo) return null;
  
  try{
    await setDoc(doc(db, "users", userId), {
      photoURL: base64Photo
    }, { merge: true });
    return base64Photo;
  } catch(e){
    console.error("Failed to save photo to Firestore:", e);
    return null;
  }
}

async function getPhotoFromFirestore(userId){
  try{
    const docSnap = await getDoc(doc(db, "users", userId));
    if(docSnap.exists() && docSnap.data().photoURL){
      return docSnap.data().photoURL;
    }
  } catch(e){
    console.error("Failed to get photo from Firestore:", e);
  }
  return null;
}

/* ---- FLOW ---- */
function proceed(){
  status.textContent="";
  status.style.color="#ff8a80";

  if(step==="email"){
    if(!email.value) return status.textContent="Enter email";

    // BAN CHECK at email step
    const banResult = checkEmailBanned(email.value);
    if(banResult.banned){
      showBanScreen(email.value, banResult.reason, banResult.matchedWords);
      return;
    }

    step="password";
    showStep("password");
    title.textContent="Enter password";
    subtitle.textContent = "for " + email.value;
    requestAnimationFrame(() => {
      password.focus();
    });
    return;
  }

  if(step==="password"){
    if(!password.value) return status.textContent="Enter password";

    if(mode==="signin"){
      nextBtn.disabled = true;
      nextBtn.textContent = "Signing in...";
      signInWithEmailAndPassword(auth,email.value,password.value)
        .then(async cred=>{
          const photoURL = await getPhotoFromFirestore(cred.user.uid);
          saveAccount(cred.user, photoURL, true);
          handleSuccess(cred.user);
        })
        .catch(e=>{
          console.error(e);
          status.textContent=e.message;
          nextBtn.disabled = false;
          nextBtn.textContent = "Next";
        });
      return;
    }

    step="profile";
    showStep("profile");
    title.textContent="Set up your profile";
    subtitle.textContent="How you'll appear on Jxo";
    nextBtn.textContent="Create account";
    
    if(email.value){
      profileInitial.textContent = email.value[0].toUpperCase();
    }
    
    requestAnimationFrame(() => {
      displayName.focus();
    });
    return;
  }

  if(step==="profile"){
    nextBtn.disabled = true;
    nextBtn.textContent = "Creating...";
    
    createUserWithEmailAndPassword(auth,email.value,password.value)
      .then(async cred=>{
        let photoURL = null;
        if(uploadedPhotoBase64){
          photoURL = await savePhotoToFirestore(cred.user.uid, uploadedPhotoBase64);
        }

        return updateProfile(cred.user,{
          displayName:displayName.value || email.value.split('@')[0]
        }).then(()=>({ user: cred.user, photoURL }));
      })
      .then(({user, photoURL})=>{
        saveAccount(user, photoURL, true);
        handleSuccess(user);
      })
      .catch(e=>{
        console.error(e);
        status.textContent=e.message;
        nextBtn.disabled = false;
        nextBtn.textContent = "Create account";
      });
  }
}

function handleSuccess(user){
  user.getIdToken().then(token=>{
    const r=new URLSearchParams(location.search).get("redirect");
    if(r) {
      location.href=r+"#token="+token;
    } else {
      status.textContent = "‚úì Signed in successfully!";
      status.style.color = "#81c784";
      setTimeout(() => {
        renderAccounts();
      }, 1500);
    }
  });
}

/* ---- TOGGLE ---- */
toggle.onclick=()=>{
  const accounts = getSavedAccounts();
  
  if(accounts.length > 0 && step === "password"){
    renderAccounts();
    step = "email";
    email.value = "";
    password.value = "";
    status.textContent = "";
    nextBtn.textContent = "Next";
    nextBtn.disabled = false;
    return;
  }

  mode = mode==="signin" ? "create" : "signin";
  step = "email";
  showStep("email");
  title.textContent = mode==="signin" ? "Sign in" : "Create account";
  subtitle.textContent = mode==="signin" ? "Use your Jxo Account" : "Create your Jxo Account";
  nextBtn.textContent = "Next";
  nextBtn.style.display = "block";
  toggle.textContent = mode==="signin" ? "Don't have an account? Create one!" : "Already have an account? Sign in";
  email.value = "";
  password.value = "";
  displayName.value = "";
  photoFile.value = "";
  uploadedPhotoBase64 = null;
  profilePicPreview.innerHTML = '<span id="profileInitial">?</span>';
  status.textContent = "";
  accountList.innerHTML = "";
  requestAnimationFrame(() => {
    email.focus();
  });
};

/* ---- ACCOUNT SELECTION ---- */
accountList.addEventListener("click", async (e) => {
  const accountDiv = e.target.closest(".account");
  if(!accountDiv) return;

  const removeBtn = e.target.closest(".account-remove");
  if(removeBtn){
    e.stopPropagation();
    const emailToRemove = removeBtn.dataset.remove;
    removeAccount(emailToRemove);
    return;
  }

  const selectedEmail = accountDiv.dataset.email;

  // BAN CHECK when selecting a saved account
  const banResult = checkEmailBanned(selectedEmail);
  if(banResult.banned){
    showBanScreen(selectedEmail, banResult.reason, banResult.matchedWords);
    return;
  }

  const accounts = getSavedAccounts();
  const account = accounts.find(a => a.email === selectedEmail);
  
  if(account){
    if(isSessionValid(account)){
      title.textContent = "Signing in...";
      subtitle.textContent = account.displayName;
      status.textContent = "Session still valid! Redirecting...";
      status.style.color = "#81c784";
      
      auth.onAuthStateChanged(async (user) => {
        if(user && user.email === account.email){
          const photoURL = await getPhotoFromFirestore(user.uid);
          saveAccount(user, photoURL, true);
          handleSuccess(user);
        } else {
          email.value = account.email;
          mode = "signin";
          step = "password";
          showStep("password");
          title.textContent = "Welcome back";
          subtitle.textContent = account.displayName;
          nextBtn.style.display = "block";
          nextBtn.textContent = "Next";
          toggle.textContent = "Use another account";
          status.textContent = "";
          requestAnimationFrame(() => {
            password.focus();
          });
        }
      });
    } else {
      email.value = account.email;
      mode = "signin";
      step = "password";
      showStep("password");
      title.textContent = "Welcome back";
      subtitle.textContent = account.displayName;
      nextBtn.style.display = "block";
      nextBtn.textContent = "Next";
      toggle.textContent = "Use another account";
      requestAnimationFrame(() => {
        password.focus();
      });
    }
  }
});

/* ---- ENTER KEY ---- */
email.addEventListener("keydown", e => {
  if(e.key === "Enter") { e.preventDefault(); proceed(); }
});

password.addEventListener("keydown", e => {
  if(e.key === "Enter") { e.preventDefault(); proceed(); }
});

displayName.addEventListener("keydown", e => {
  if(e.key === "Enter") { e.preventDefault(); proceed(); }
});

nextBtn.onclick = proceed;

// Init
checkTrustedSite();
loadBans();
renderAccounts();
if(getSavedAccounts().length === 0){
  email.focus();
}
</script>

</body>
</html>